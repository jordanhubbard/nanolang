name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        include:
          - os: macos-14
            arch: arm64
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show platform info
        run: |
          echo "OS: ${{ runner.os }}"
          echo "Architecture: ${{ matrix.arch || 'default' }}"
          uname -a || systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            valgrind \
            pkg-config \
            libsdl2-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libncurses-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc pkg-config sdl2 sdl2_mixer sdl2_ttf

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          # Install build tools via chocolatey
          choco install -y mingw make
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
          
          # Install SDL2 packages via vcpkg (pre-installed on GitHub Actions)
          vcpkg install sdl2:x64-windows sdl2-mixer:x64-windows sdl2-ttf:x64-windows
          vcpkg integrate install
          
          # Set environment variables for SDL2
          echo "SDL2_DIR=C:/vcpkg/installed/x64-windows" >> $GITHUB_ENV
          echo "C:/vcpkg/installed/x64-windows/bin" >> $GITHUB_PATH

      - name: Check dependencies
        shell: bash
        run: make check-deps

      - name: Build - Stage 1 (C Reference Compiler)
        run: make stage1

      - name: Build - Stage 2 (Self-Hosted Components)
        run: make stage2

      - name: Build - Stage 3 (Bootstrap Validation)
        run: make stage3

      - name: Run test suite
        run: make test

      - name: Show error logs on failure
        if: failure()
        shell: bash
        run: |
          echo "=== Showing first failed test logs ==="
          for log in .test_output/*.compile.log; do
            if [ -f "$log" ]; then
              echo "=== $log ==="
              cat "$log"
              echo ""
            fi
          done | head -200

      - name: Verify binaries exist
        shell: bash
        run: |
          test -f ./bin/nanoc || exit 1
          echo "‚úì Compiler binary built successfully"

      - name: Test basic examples
        shell: bash
        run: |
          ./bin/nanoc examples/nl_hello.nano -o hello_test
          ./hello_test
          ./bin/nanoc examples/nl_factorial.nano -o factorial_test
          ./factorial_test
          rm -f hello_test factorial_test

      # Valgrind checks disabled - small leaks acceptable for short-lived compiler
      # - name: Check for memory leaks (Linux only)
      #   if: runner.os == 'Linux'
      #   run: make valgrind || true

  docs:
    name: Docs (link check)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown links
        run: python3 scripts/check_markdown_links.py

  sanitizers:
    name: Memory Sanitizers
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Build with AddressSanitizer
        run: make sanitize

      - name: Complete 3-stage bootstrap with sanitizers
        run: make build

      - name: Run tests with sanitizers
        run: |
          # Disable leak detection for exit-time leaks in short-lived compiler process
          # AddressSanitizer still catches real memory issues (use-after-free, etc.)
          export ASAN_OPTIONS=detect_leaks=0
          make test

      - name: Show sanitizer error logs on failure
        if: failure()
        shell: bash
        run: |
          echo "=== Showing first 3 failed test logs ==="
          for log in .test_output/*.compile.log; do
            if [ -f "$log" ]; then
              echo "=== $log ==="
              cat "$log"
              echo ""
            fi
          done | head -200

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential lcov bc

      - name: Build with coverage
        run: make coverage

      - name: Complete 3-stage bootstrap with coverage
        run: make build

      - name: Run tests
        run: make test

      - name: Show error logs on failure
        if: failure()
        shell: bash
        run: |
          echo "=== Showing first failed test logs ==="
          for log in .test_output/*.compile.log; do
            if [ -f "$log" ]; then
              echo "=== $log ==="
              cat "$log"
              echo ""
            fi
          done | head -200

      - name: Generate coverage report
        run: |
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info --ignore-errors unused
          lcov --remove coverage.info '*/cJSON.c' --output-file coverage.info --ignore-errors unused
          lcov --list coverage.info

      - name: Generate HTML coverage report
        run: |
          genhtml coverage.info --output-directory coverage-html

      - name: Calculate coverage percentage
        id: coverage
        run: |
          # Extract overall line coverage percentage
          COVERAGE=$(lcov --summary coverage.info 2>&1 | grep "lines" | grep -oE '[0-9]+\.[0-9]+%' | head -1 | sed 's/%//')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Coverage: $COVERAGE%"

      - name: Enforce coverage threshold
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=50.0
          echo "Current coverage: $COVERAGE%"
          echo "Required threshold: $THRESHOLD%"
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "‚ùå Coverage $COVERAGE% is below threshold $THRESHOLD%"
            echo "Please add tests to improve coverage."
            exit 1
          else
            echo "‚úÖ Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

      - name: Upload coverage report to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.info
            coverage-html/

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const body = `## Code Coverage Report\n\nüìä **Coverage: ${coverage}%**\n\n‚úÖ Coverage threshold (50%) met.\n\n[View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });

  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comparison

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc

      - name: Download baseline benchmark
        id: baseline
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: performance-baseline
          path: .benchmark_baseline

      - name: Run performance benchmarks
        run: |
          ./scripts/benchmark.sh
          cp .benchmark_results/benchmark_*.json .benchmark_results/current.json

      - name: Compare with baseline
        id: compare
        if: steps.baseline.outcome == 'success'
        run: |
          BASELINE=.benchmark_baseline/baseline.json
          CURRENT=.benchmark_results/current.json
          
          if [ ! -f "$BASELINE" ]; then
            echo "No baseline found, skipping comparison"
            echo "regression=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract key metrics
          BASELINE_BUILD=$(grep "total_build_ms" "$BASELINE" | grep -oE '[0-9]+')
          CURRENT_BUILD=$(grep "total_build_ms" "$CURRENT" | grep -oE '[0-9]+')
          
          BASELINE_TEST=$(grep "test_suite_ms" "$BASELINE" | grep -oE '[0-9]+')
          CURRENT_TEST=$(grep "test_suite_ms" "$CURRENT" | grep -oE '[0-9]+')
          
          BASELINE_COMPILE=$(grep "self_hosting_compile_ms" "$BASELINE" | grep -oE '[0-9]+')
          CURRENT_COMPILE=$(grep "self_hosting_compile_ms" "$CURRENT" | grep -oE '[0-9]+')
          
          # Calculate percentage changes
          BUILD_PCT=$(echo "scale=2; ($CURRENT_BUILD - $BASELINE_BUILD) * 100 / $BASELINE_BUILD" | bc)
          TEST_PCT=$(echo "scale=2; ($CURRENT_TEST - $BASELINE_TEST) * 100 / $BASELINE_TEST" | bc)
          COMPILE_PCT=$(echo "scale=2; ($CURRENT_COMPILE - $BASELINE_COMPILE) * 100 / $BASELINE_COMPILE" | bc)
          
          echo "build_change=$BUILD_PCT" >> $GITHUB_OUTPUT
          echo "test_change=$TEST_PCT" >> $GITHUB_OUTPUT
          echo "compile_change=$COMPILE_PCT" >> $GITHUB_OUTPUT
          
          # Check for regressions (>20% slower)
          REGRESSION=false
          if (( $(echo "$BUILD_PCT > 20" | bc -l) )); then
            echo "‚ö†Ô∏è  Build time regression: +${BUILD_PCT}% (${BASELINE_BUILD}ms ‚Üí ${CURRENT_BUILD}ms)"
            REGRESSION=true
          fi
          if (( $(echo "$TEST_PCT > 20" | bc -l) )); then
            echo "‚ö†Ô∏è  Test time regression: +${TEST_PCT}% (${BASELINE_TEST}ms ‚Üí ${CURRENT_TEST}ms)"
            REGRESSION=true
          fi
          if (( $(echo "$COMPILE_PCT > 20" | bc -l) )); then
            echo "‚ö†Ô∏è  Compile time regression: +${COMPILE_PCT}% (${BASELINE_COMPILE}ms ‚Üí ${CURRENT_COMPILE}ms)"
            REGRESSION=true
          fi
          
          echo "regression=$REGRESSION" >> $GITHUB_OUTPUT
          
          # Create comparison report
          cat > .benchmark_results/comparison.md << EOF
          ## Performance Comparison
          
          | Metric | Baseline | Current | Change |
          |--------|----------|---------|--------|
          | Build Time | ${BASELINE_BUILD}ms | ${CURRENT_BUILD}ms | ${BUILD_PCT}% |
          | Test Suite | ${BASELINE_TEST}ms | ${CURRENT_TEST}ms | ${TEST_PCT}% |
          | Self-Host Compile | ${BASELINE_COMPILE}ms | ${CURRENT_COMPILE}ms | ${COMPILE_PCT}% |
          EOF

      - name: Fail on regression
        if: steps.compare.outputs.regression == 'true'
        run: |
          echo "‚ùå Performance regression detected (>20% slower)"
          echo "See comparison report in artifacts for details"
          cat .benchmark_results/comparison.md
          exit 1

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: .benchmark_results/

      - name: Update performance baseline (main branch only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: performance-baseline
          path: .benchmark_results/current.json

      - name: Comment performance on PR
        if: github.event_name == 'pull_request' && steps.compare.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const buildChange = '${{ steps.compare.outputs.build_change }}';
            const testChange = '${{ steps.compare.outputs.test_change }}';
            const compileChange = '${{ steps.compare.outputs.compile_change }}';
            
            let emoji = '‚úÖ';
            if (parseFloat(buildChange) > 20 || parseFloat(testChange) > 20 || parseFloat(compileChange) > 20) {
              emoji = '‚ö†Ô∏è';
            } else if (parseFloat(buildChange) < -10 || parseFloat(testChange) < -10 || parseFloat(compileChange) < -10) {
              emoji = 'üöÄ';
            }
            
            const body = `## ${emoji} Performance Report\n\n| Metric | Change |\n|--------|--------|\n| Build Time | ${buildChange}% |\n| Test Suite | ${testChange}% |\n| Self-Host Compile | ${compileChange}% |\n\n[View detailed benchmarks in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: body
            });

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang-tidy

      - name: Run clang-tidy
        run: |
          clang-tidy src/*.c -- -Isrc || true
