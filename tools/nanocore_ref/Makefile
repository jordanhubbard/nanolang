# NanoCore Reference Interpreter - Coq-extracted OCaml evaluator
#
# Builds the nanocore-ref binary from Coq-extracted OCaml code + wrapper.
# The extracted code lives in ../../formal/extracted/ and is generated by
# running `make extract` in the formal/ directory.

OCAMLFIND = ocamlfind
OCAMLOPT = $(OCAMLFIND) ocamlopt
PACKAGES = -package zarith
GMP_PREFIX = $(shell brew --prefix gmp 2>/dev/null || echo /usr/local)
OCAMLFLAGS = -I ../../formal/extracted $(PACKAGES) -ccopt -L$(GMP_PREFIX)/lib

EXTRACTED_DIR = ../../formal/extracted

# Order matters: dependencies must come before dependents
EXTRACTED_MODULES = \
	$(EXTRACTED_DIR)/Decimal.ml \
	$(EXTRACTED_DIR)/Hexadecimal.ml \
	$(EXTRACTED_DIR)/Number.ml \
	$(EXTRACTED_DIR)/Nat.ml \
	$(EXTRACTED_DIR)/Datatypes.ml \
	$(EXTRACTED_DIR)/PosDef.ml \
	$(EXTRACTED_DIR)/BinNums.ml \
	$(EXTRACTED_DIR)/BinInt.ml \
	$(EXTRACTED_DIR)/Bool.ml \
	$(EXTRACTED_DIR)/Ascii.ml \
	$(EXTRACTED_DIR)/String.ml \
	$(EXTRACTED_DIR)/List.ml \
	$(EXTRACTED_DIR)/Syntax.ml \
	$(EXTRACTED_DIR)/Semantics.ml \
	$(EXTRACTED_DIR)/EvalFn.ml

TARGET = nanocore-ref
INSTALL_DIR = ../../bin

all: $(TARGET)

$(TARGET): $(EXTRACTED_MODULES) main.ml
	$(OCAMLOPT) $(OCAMLFLAGS) -linkpkg $(EXTRACTED_MODULES) main.ml -o $@

install: $(TARGET)
	mkdir -p $(INSTALL_DIR)
	cp $(TARGET) $(INSTALL_DIR)/

clean:
	rm -f $(TARGET) *.cmx *.cmi *.o
	rm -f $(EXTRACTED_DIR)/*.cmx $(EXTRACTED_DIR)/*.cmi $(EXTRACTED_DIR)/*.o

.PHONY: all install clean
