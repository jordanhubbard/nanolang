# SDL NanoAmp - Pixel-Perfect Winamp Tribute
# Ultimate Winamp aesthetic with tight layout and authentic styling
#
# Features:
# - Classic Winamp layout and color scheme
# - Compact transport controls with symbols
# - Prominent track info display
# - Professional visualization panel
# - Integrated playlist with proper styling
# - Status bar with playback info
# - Directory browser for music discovery
#
# Usage: ./bin/sdl_nanoamp [optional: path/to/music/directory]

import "modules/sdl/sdl.nano"
import "modules/sdl_helpers/sdl_helpers.nano"
import "modules/sdl_mixer/sdl_mixer.nano"
import "modules/sdl_ttf/sdl_ttf.nano"
import "modules/sdl_ttf/sdl_ttf_helpers.nano"
import "modules/audio_viz/audio_viz.nano"
import "modules/ui_widgets/ui_widgets.nano"
import "modules/filesystem/filesystem.nano"
import "modules/preferences/preferences.nano"

let WINDOW_WIDTH: int = 600
let WINDOW_HEIGHT: int = 650

# Winamp color palette
let WINAMP_BG_R: int = 16
let WINAMP_BG_G: int = 20
let WINAMP_BG_B: int = 32

let WINAMP_PANEL_R: int = 8
let WINAMP_PANEL_G: int = 12
let WINAMP_PANEL_B: int = 20

let WINAMP_HIGHLIGHT_R: int = 60
let WINAMP_HIGHLIGHT_G: int = 100
let WINAMP_HIGHLIGHT_B: int = 180

let WINAMP_ACCENT_R: int = 0
let WINAMP_ACCENT_G: int = 255
let WINAMP_ACCENT_B: int = 100

# Playback states
let STATE_STOPPED: int = 0
let STATE_PLAYING: int = 1
let STATE_PAUSED: int = 2

# UI modes
let MODE_PLAYER: int = 0
let MODE_BROWSER: int = 1

# Repeat modes
let REPEAT_OFF: int = 0
let REPEAT_ALL: int = 1
let REPEAT_ONE: int = 2

# Command-line args
extern fn get_argc() -> int
extern fn get_argv(index: int) -> string
extern fn rand() -> int

# String helpers (we'll need these)
fn get_filename_from_path(path: string) -> string {
    # Extract just the filename from a full path
    # Simple version - just return the path for now
    # In real implementation would parse the path
    return path
}

shadow get_filename_from_path {
    assert (== (get_filename_from_path "song.mod") "song.mod")
    assert (== (get_filename_from_path "a/b/c.wav") "a/b/c.wav")
}

# Safe music loading with error handling
fn try_load_and_play_music(track_path: string) -> int {
    let music: Mix_Music = (Mix_LoadMUS track_path)
    if (== music 0) {
        # Failed to load - get error message
        (print "âœ— Failed to load: ")
        (println track_path)
        (print "  Error: ")
        (println (Mix_GetError))
        return 0  # Failure
    } else {
        # Successfully loaded - start playing
        let play_result: int = (Mix_PlayMusic music -1)
        if (== play_result 0) {
            return 1  # Success
        } else {
            (print "âœ— Failed to play: ")
            (println track_path)
            (print "  Error: ")
            (println (Mix_GetError))
            return 0  # Failure
        }
    }
}

fn main() -> int {
    (println "")
    (println "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    (println "â•‘  NANOAMP ENHANCED - PIXEL-PERFECT WINAMP TRIBUTE      â•‘")
    (println "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    (println "")
    
    # Load preferences and music
    let pref_path: string = (nl_prefs_get_path "nanoamp")
    (print "Preferences: ")
    (println pref_path)
    
    let argc: int = (get_argc)
    let mut playlist: array<string> = []
    let mut playlist_count: int = 0
    
    # Load from command line or preferences
    if (>= argc 2) {
        unsafe { let music_dir: string = (get_argv 1) }
        (print "Loading from: ")
        (println music_dir)
        
        let files: array<string> = (nl_fs_list_files music_dir ".mp3")
        let file_count: int = (array_length files)
        
        let mut i: int = 0
        while (< i file_count) {
            let filename: string = (at files i)
            let full_path: string = (nl_fs_join_path music_dir filename)
            set playlist (array_push playlist full_path)
            set i (+ i 1)
        }
        set playlist_count (array_length playlist)
        
        (print "âœ“ Loaded ")
        (print playlist_count)
        (println " MP3 files")
    } else {
        (println "Loading saved playlist...")
        set playlist (nl_prefs_load_playlist pref_path)
        set playlist_count (array_length playlist)
        
        if (== playlist_count 0) {
            (println "No saved playlist - starting empty")
        } else {
            (print "âœ“ Loaded ")
            (print playlist_count)
            (println " saved tracks")
        }
    }
    (println "")
    
    # Initialize SDL
    unsafe {     (SDL_Init (+ SDL_INIT_VIDEO SDL_INIT_AUDIO)) }
    
    # Initialize SDL_mixer
    let mixer_init: int = (Mix_Init 8)
    if (!= mixer_init 8) {
        (println "âœ— SDL_mixer MP3 support failed")
        unsafe {         (SDL_Quit) }
        return 1
    } else {}
    
    let audio_result: int = (Mix_OpenAudio 44100 32784 2 2048)
    if (!= audio_result 0) {
        (println "âœ— Failed to open audio")
        unsafe {         (Mix_Quit) }
        unsafe {         (SDL_Quit) }
        return 1
    } else {}
    
    (println "âœ“ SDL_mixer ready")
    
    # Initialize visualization
    unsafe {     (nl_audio_viz_init 32784 2) }
    (println "âœ“ Audio visualization ready")
    
    # Initialize SDL_ttf
    unsafe {     (TTF_Init) }
    
    # Create window
    let window: SDL_Window = (SDL_CreateWindow "â™« NanoAmp - Winamp Tribute â™«"
                                                SDL_WINDOWPOS_CENTERED
                                                SDL_WINDOWPOS_CENTERED
                                                WINDOW_WIDTH WINDOW_HEIGHT
                                                SDL_WINDOW_SHOWN)
    let renderer: SDL_Renderer = (SDL_CreateRenderer window -1
                                                      (+ SDL_RENDERER_ACCELERATED SDL_RENDERER_PRESENTVSYNC))
    
    # Load fonts - different sizes for hierarchy
    let title_font: TTF_Font = (nl_open_font_portable "Arial" 20)
    let font: TTF_Font = (nl_open_font_portable "Arial" 14)
    let small_font: TTF_Font = (nl_open_font_portable "Arial" 11)
    let tiny_font: TTF_Font = (nl_open_font_portable "Arial" 9)
    
    if (== font 0) {
        (println "âœ— Failed to load fonts")
        unsafe {         (SDL_DestroyRenderer renderer) }
        unsafe {         (SDL_DestroyWindow window) }
        unsafe {         (TTF_Quit) }
        unsafe {         (Mix_CloseAudio) }
        unsafe {         (Mix_Quit) }
        unsafe {         (SDL_Quit) }
        return 1
    } else {}
    
    (println "")
    # State variables
    let mut running: bool = true
    let mut playback_state: int = STATE_STOPPED
    let mut current_track_index: int = 0
    let mut volume: float = 0.625  # 80/128
    let mut viz_mode: int = 1  # Start with frequency bars (most Winamp-like)
    let num_viz_modes: int = 3
    let mut frame: int = 0
    
    # UI mode
    let mut ui_mode: int = MODE_PLAYER
    let mut browser_path: string = (nl_prefs_get_home)
    let mut browser_scroll: int = 0
    
    # Time tracking
    let mut playback_start_ticks: int = 0
    let mut playback_time: int = 0
    let mut track_duration: int = 215  # 3:35 default
    
    # Playback modes
    let mut shuffle_mode: int = 0
    let mut repeat_mode: int = REPEAT_OFF
    
    # Set initial volume
    unsafe {     (Mix_VolumeMusic 80) }
    
    (println "Ready! Click Browse to add music or drag files to playlist")
    (println "")
    
    # === MAIN LOOP ===
    while running {
        # Event handling
        if (== (nl_sdl_poll_event_quit) 1) {
            set running false
        } else {}
        
        let key: int = (nl_sdl_poll_keypress)
        if (== key 41) {  # ESC
            set running false
        } else {}
        
        if (== key 43) {  # TAB
            set viz_mode (% (+ viz_mode 1) num_viz_modes)
            if (== viz_mode 0) { (println "ğŸŒ€ Circular Spectrum") } else {}
            if (== viz_mode 1) { (println "ğŸ“Š Frequency Bars") } else {}
            if (== viz_mode 2) { (println "ğŸŒŠ Oscilloscope") } else {}
        } else {}
        
        # CRITICAL: Update widget mouse state ONCE per frame BEFORE rendering widgets
        unsafe {         (nl_ui_update_mouse_state) }
        
        # Update playback time
        if (== playback_state STATE_PLAYING) {
            let current_ticks: int = (SDL_GetTicks)
            set playback_time (/ (- current_ticks playback_start_ticks) 1000)
            
            # Check if track finished
            if (>= playback_time track_duration) {
                if (== repeat_mode REPEAT_ONE) {
                    set playback_time 0
                    set playback_start_ticks (SDL_GetTicks)
                } else {
                    # Next track
                    if (< (+ current_track_index 1) playlist_count) {
                        set current_track_index (+ current_track_index 1)
                    } else {
                        if (== repeat_mode REPEAT_ALL) {
                            set current_track_index 0
                        } else {
                            set playback_state STATE_STOPPED
                            set current_track_index 0
                        }
                    }
                    set playback_time 0
                    set playback_start_ticks (SDL_GetTicks)
                }
            } else {}
        } else {}
        
        # === RENDERING ===
        
        # Clear with Winamp dark blue-gray
        unsafe {         (SDL_SetRenderDrawColor renderer WINAMP_BG_R WINAMP_BG_G WINAMP_BG_B 255) }
        unsafe {         (SDL_RenderClear renderer) }
        
        if (== ui_mode MODE_BROWSER) {
            # === DIRECTORY BROWSER MODE ===
            
            # Mouse wheel scrolling
            let wheel_delta: int = (nl_sdl_poll_mouse_wheel)
            if (!= wheel_delta 0) {
                # Scroll up (positive) = decrease scroll offset, scroll down (negative) = increase
                set browser_scroll (- browser_scroll wheel_delta)
                if (< browser_scroll 0) {
                    set browser_scroll 0
                } else {}
            } else {}
            
            unsafe {             (nl_ui_label renderer title_font "Browse Music Directory" 20 15 200 220 255 255) }
            unsafe {             (nl_ui_label renderer tiny_font browser_path 20 45 180 180 200 255) }
            
            # Navigation buttons
            if (== (nl_ui_button renderer font ".." 20 70 60 25) 1) {
                set browser_path (nl_fs_join_path browser_path "..")
                set browser_scroll 0
            } else {}
            
            if (== (nl_ui_button renderer font "Select Folder" 90 70 120 25) 1) {
                let files: array<string> = (nl_fs_list_files browser_path ".mp3")
                let file_count: int = (array_length files)
                
                let mut i: int = 0
                while (< i file_count) {
                    let filename: string = (at files i)
                    let full_path: string = (nl_fs_join_path browser_path filename)
                    set playlist (array_push playlist full_path)
                    set i (+ i 1)
                }
                set playlist_count (array_length playlist)
                
                (print "Added ")
                (print file_count)
                (println " MP3 files")
                set ui_mode MODE_PLAYER
            } else {}
            
            if (== (nl_ui_button renderer font "Cancel" 220 70 70 25) 1) {
                set ui_mode MODE_PLAYER
            } else {}
            
            # Scroll buttons
            if (== (nl_ui_button renderer font "^" 565 110 30 30) 1) {
                if (> browser_scroll 0) {
                    set browser_scroll (- browser_scroll 1)
                } else {}
            } else {}
            
            if (== (nl_ui_button renderer font "v" 565 560 30 30) 1) {
                set browser_scroll (+ browser_scroll 1)
            } else {}
            
            # List directories and files together
            let dirs: array<string> = (nl_fs_list_dirs browser_path)
            let dir_count: int = (array_length dirs)
            let files: array<string> = (nl_fs_list_files browser_path ".mp3")
            let file_count: int = (array_length files)
            let total_items: int = (+ dir_count file_count)
            
            if (== total_items 0) {
                unsafe {                 (nl_ui_label renderer small_font "No directories or MP3 files" 30 110 150 150 150 255) }
            } else {
                let mut item_y: int = 110
                let mut item_i: int = browser_scroll
                let max_visible: int = 19  # Max items to show
                let mut visible_count: int = 0
                
                # Render directories first (in cyan/blue)
                while (< item_i dir_count) {
                    if (>= visible_count max_visible) {
                        set item_i dir_count  # Exit loop
                    } else {
                        let dir_name: string = (at dirs item_i)
                        
                        # Directory button in cyan
                        if (== (nl_ui_button renderer small_font dir_name 20 item_y 540 22) 1) {
                            set browser_path (nl_fs_join_path browser_path dir_name)
                            set browser_scroll 0
                        } else {}
                        
                        # Draw folder indicator [DIR] in cyan
                        unsafe {                         (nl_ui_label renderer tiny_font "[DIR]" 480 item_y 100 200 255 255) }
                        
                        set item_y (+ item_y 25)
                        set item_i (+ item_i 1)
                        set visible_count (+ visible_count 1)
                    }
                }
                
                # Then render files (in white/gray)
                if (< visible_count max_visible) {
                    let mut file_start: int = (- item_i dir_count)
                    if (< file_start 0) {
                        set file_start 0
                    } else {}
                    
                    let mut file_i: int = file_start
                    while (< file_i file_count) {
                        if (>= visible_count max_visible) {
                            set file_i file_count  # Exit loop
                        } else {
                            let filename: string = (at files file_i)
                            
                            # File button in normal color
                            if (== (nl_ui_button renderer small_font filename 20 item_y 540 22) 1) {
                                # Add single file to playlist
                                let full_path: string = (nl_fs_join_path browser_path filename)
                                set playlist (array_push playlist full_path)
                                set playlist_count (array_length playlist)
                                (print "Added: ")
                                (println filename)
                                set ui_mode MODE_PLAYER
                            } else {}
                            
                            # Draw file indicator [MP3] in gray
                            unsafe {                             (nl_ui_label renderer tiny_font "[MP3]" 480 item_y 150 150 150 255) }
                            
                            set item_y (+ item_y 25)
                            set file_i (+ file_i 1)
                            set visible_count (+ visible_count 1)
                        }
                    }
                } else {}
                
                # Show scroll position indicator
                if (> total_items max_visible) {
                    unsafe {                     (nl_ui_label renderer tiny_font "Scroll:" 565 145 150 150 150 255) }
                    let scroll_pos: string = (int_to_string (+ browser_scroll 1))
                    let scroll_total: string = (int_to_string total_items)
                    unsafe {                     (nl_ui_label renderer tiny_font scroll_pos 565 165 150 150 150 255) }
                    unsafe {                     (nl_ui_label renderer tiny_font "/" 577 165 150 150 150 255) }
                    unsafe {                     (nl_ui_label renderer tiny_font scroll_total 585 165 150 150 150 255) }
                } else {}
            }
            
        } else {
            # === PLAYER MODE - WINAMP STYLE LAYOUT ===
            
            # === 1. TITLE BAR / TRACK INFO PANEL ===
            # Dark panel with track name prominently displayed
            unsafe {             (nl_ui_panel renderer 5 5 590 70 WINAMP_PANEL_R WINAMP_PANEL_G WINAMP_PANEL_B 255) }
            
            # App title/logo
            unsafe {             (nl_ui_label renderer title_font "â™« NanoAmp" 15 10 WINAMP_ACCENT_R WINAMP_ACCENT_G WINAMP_ACCENT_B 255) }
            
            # Track name (get filename only, no path)
            let mut current_track_display: string = ""
            if (< current_track_index playlist_count) {
                set current_track_display (at playlist current_track_index)
            } else {
                set current_track_display "No track loaded"
            }
            
            # Show in smaller text under title
            unsafe {             (nl_ui_label renderer small_font current_track_display 15 38 200 220 255 255) }
            
            # Track metadata (mock for now)
            unsafe {             (nl_ui_label renderer tiny_font "128kbps â€¢ 44.1kHz â€¢ Stereo" 15 58 120 160 180 255) }
            
            # Time display - RIGHT ALIGNED, LARGE
            unsafe {             (nl_ui_time_display renderer title_font playback_time 430 12 WINAMP_ACCENT_R WINAMP_ACCENT_G WINAMP_ACCENT_B 255) }
            unsafe {             (nl_ui_label renderer title_font "/" 483 12 120 140 160 255) }
            unsafe {             (nl_ui_time_display renderer title_font track_duration 500 12 WINAMP_ACCENT_R WINAMP_ACCENT_G WINAMP_ACCENT_B 255) }
            
            # Track position indicator
            let mut track_pos_text: string = ""
            if (> playlist_count 0) {
                set track_pos_text (int_to_string (+ current_track_index 1))
                set track_pos_text (str_concat track_pos_text " of ")
                set track_pos_text (str_concat track_pos_text (int_to_string playlist_count))
            } else {
                set track_pos_text "0 of 0"
            }
            unsafe {             (nl_ui_label renderer tiny_font track_pos_text 495 58 150 160 180 255) }
            
            # === 2. SEEKABLE PROGRESS BAR ===
            let mut progress: float = 0.0
            if (> track_duration 0) {
                set progress (/ (cast_float playback_time) (cast_float track_duration))
            } else {}
            
            let seek_pos: float = (nl_ui_seekable_progress_bar renderer 10 85 580 14 progress)
            if (> seek_pos -0.5) {
                set playback_time (cast_int (* seek_pos (cast_float track_duration)))
                set playback_start_ticks (- (SDL_GetTicks) (* playback_time 1000))
            } else {}
            
            # === 3. TRANSPORT CONTROLS - COMPACT LAYOUT ===
            let ctrl_y: int = 108
            let btn_h: int = 26
            
            # Previous
            if (== (nl_ui_button renderer font "|<<" 15 ctrl_y 42 btn_h) 1) {
                if (> current_track_index 0) {
                    set current_track_index (- current_track_index 1)
                    set playback_time 0
                    set playback_start_ticks (SDL_GetTicks)
                    (println "[*] Previous")
                } else {}
            } else {}
            
            # Play
            if (== (nl_ui_button renderer font ">" 62 ctrl_y 50 btn_h) 1) {
                if (> playlist_count 0) {
                    if (== playback_state STATE_STOPPED) {
                        let track_path: string = (at playlist current_track_index)
                        let load_result: int = (try_load_and_play_music track_path)
                        if (== load_result 1) {
                            # Successfully loaded and playing
                            set playback_state STATE_PLAYING
                            set playback_start_ticks (SDL_GetTicks)
                            (println "[*] Play")
                        } else {
                            # Failed to load - show error and try next track
                            (println "[*] Error loading track, skipping to next...")
                            
                            # Try to auto-skip to next valid track
                            if (< playlist_count 10) {
                                # Small playlist - try next track
                                set current_track_index (% (+ current_track_index 1) playlist_count)
                                let next_path: string = (at playlist current_track_index)
                                let next_result: int = (try_load_and_play_music next_path)
                                if (== next_result 1) {
                                    set playback_state STATE_PLAYING
                                    set playback_start_ticks (SDL_GetTicks)
                                    (println "[*] Skipped to next track")
                                } else {
                                    (println "[*] Next track also failed")
                                }
                            } else {}
                        }
                    } else {
                        if (== playback_state STATE_PAUSED) {
                            unsafe {                             (Mix_ResumeMusic) }
                            set playback_state STATE_PLAYING
                            set playback_start_ticks (- (SDL_GetTicks) (* playback_time 1000))
                            (println "[*] Resume")
                        } else {}
                    }
                } else {}
            } else {}
            
            # Pause
            if (== (nl_ui_button renderer font "||" 117 ctrl_y 42 btn_h) 1) {
                if (== playback_state STATE_PLAYING) {
                    unsafe {                     (Mix_PauseMusic) }
                    set playback_state STATE_PAUSED
                    (println "[*] Pause")
                } else {}
            } else {}
            
            # Stop
            if (== (nl_ui_button renderer font "[]" 164 ctrl_y 42 btn_h) 1) {
                unsafe {                 (Mix_HaltMusic) }
                set playback_state STATE_STOPPED
                set playback_time 0
                (println "[*] Stop")
            } else {}
            
            # Next
            if (== (nl_ui_button renderer font ">>|" 211 ctrl_y 42 btn_h) 1) {
                if (< (+ current_track_index 1) playlist_count) {
                    set current_track_index (+ current_track_index 1)
                    set playback_time 0
                    set playback_start_ticks (SDL_GetTicks)
                    (println "[*] Next")
                } else {}
            } else {}
            
            # === 4. MODE CONTROLS ===
            # Shuffle
            let mut shuffle_label: string = ""
            if (== shuffle_mode 1) {
                set shuffle_label "SHF"
            } else {
                set shuffle_label "shf"
            }
            if (== (nl_ui_button renderer font shuffle_label 268 ctrl_y 38 btn_h) 1) {
                if (== shuffle_mode 0) {
                    set shuffle_mode 1
                    (println "[*] Shuffle ON")
                } else {
                    set shuffle_mode 0
                    (println "[*] Shuffle OFF")
                }
            } else {}
            
            # Repeat
            let mut repeat_label: string = ""
            if (== repeat_mode REPEAT_OFF) { set repeat_label "rep" } else {}
            if (== repeat_mode REPEAT_ALL) { set repeat_label "REP" } else {}
            if (== repeat_mode REPEAT_ONE) { set repeat_label "RE1" } else {}
            
            if (== (nl_ui_button renderer font repeat_label 311 ctrl_y 38 btn_h) 1) {
                set repeat_mode (% (+ repeat_mode 1) 3)
                if (== repeat_mode REPEAT_OFF) { (println "[*] Repeat OFF") } else {}
                if (== repeat_mode REPEAT_ALL) { (println "[*] Repeat ALL") } else {}
                if (== repeat_mode REPEAT_ONE) { (println "[*] Repeat ONE") } else {}
            } else {}
            
            # === 5. VOLUME CONTROL ===
            unsafe {             (nl_ui_label renderer small_font "Vol" 365 ctrl_y 120 180 220 255) }
            set volume (nl_ui_slider renderer 395 (+ ctrl_y 6) 110 14 volume)
            let vol_int: int = (cast_int (* volume 128.0))
            unsafe {             (Mix_VolumeMusic vol_int) }
            
            # Volume percentage
            let vol_pct: int = (cast_int (* volume 100.0))
            unsafe {             (nl_ui_label renderer small_font (int_to_string vol_pct) 510 ctrl_y 150 200 255 255) }
            
            # === 6. VISUALIZATION PANEL ===
            unsafe {             (nl_ui_panel renderer 5 145 590 175 WINAMP_PANEL_R WINAMP_PANEL_G WINAMP_PANEL_B 255) }
            
            # Viz mode label
            let mut viz_label: string = ""
            if (== viz_mode 0) { set viz_label "[*] Circular Spectrum" } else {}
            if (== viz_mode 1) { set viz_label "[*] Frequency Analyzer" } else {}
            if (== viz_mode 2) { set viz_label "[*] Oscilloscope" } else {}
            unsafe {             (nl_ui_label renderer tiny_font viz_label 15 150 120 160 180 255) }
            unsafe {             (nl_ui_label renderer tiny_font "TAB: Change Mode" 450 150 100 140 160 255) }
            
            # Get waveform data
            let waveform_size: int = (nl_audio_viz_get_waveform_size)
            
            # Mode 0: Circular Spectrum
            if (== viz_mode 0) {
                let center_x: int = 300
                let center_y: int = 232
                
                let mut angle: int = 0
                while (< angle 360) {
                    let idx: int = (* angle 4)
                    if (< idx waveform_size) {
                        let left: float = (nl_audio_viz_get_waveform_sample 0 idx)
                        let right: float = (nl_audio_viz_get_waveform_sample 1 idx)
                        let amp: float = (+ (abs left) (abs right))
                        let radius: int = (+ 30 (cast_int (* amp 55.0)))
                        
                        let angle_f: float = (cast_float angle)
                        let rad: float = (* angle_f 0.01745)
                        let x: int = (+ center_x (cast_int (* (cast_float radius) (cos rad))))
                        let y: int = (+ center_y (cast_int (* (cast_float radius) (sin rad))))
                        
                        let col_off: int = (+ angle frame)
                        let r: int = (+ 80 (cast_int (* 175.0 (sin (* (cast_float col_off) 0.03)))))
                        let g: int = (+ 60 (cast_int (* 195.0 (sin (* (cast_float (+ col_off 120)) 0.03)))))
                        let b: int = 255
                        
                        unsafe {                         (SDL_SetRenderDrawColor renderer r g b 255) }
                        unsafe {                         (SDL_RenderDrawPoint renderer x y) }
                        unsafe {                         (SDL_RenderDrawPoint renderer (+ x 1) y) }
                    } else {}
                    set angle (+ angle 3)
                }
            } else {}
            
            # Mode 1: Frequency Bars (Most Winamp-like!)
            if (== viz_mode 1) {
                let num_bars: int = 56
                let bar_width: int = (/ 560 num_bars)
                let mut bar: int = 0
                
                while (< bar num_bars) {
                    let idx: int = (* bar (/ waveform_size num_bars))
                    let left: float = (nl_audio_viz_get_waveform_sample 0 idx)
                    let right: float = (nl_audio_viz_get_waveform_sample 1 idx)
                    let amp: float = (+ (abs left) (abs right))
                    let height: int = (+ 8 (cast_int (* amp 130.0)))
                    
                    let bar_x: int = (+ 20 (* bar bar_width))
                    let bar_y: int = (- 305 height)
                    
                    # Gradient color - green to yellow to red
                    let color_val: int = (cast_int (* (/ (cast_float bar) (cast_float num_bars)) 255.0))
                    let r: int = (+ 0 color_val)
                    let g: int = (- 255 (/ color_val 2))
                    let b: int = 30
                    
                    unsafe {                     (SDL_SetRenderDrawColor renderer r g b 255) }
                    unsafe {                     (nl_sdl_render_fill_rect renderer bar_x bar_y (- bar_width 1) height) }
                    set bar (+ bar 1)
                }
            } else {}
            
            # Mode 2: Oscilloscope
            if (== viz_mode 2) {
                let mut i: int = 0
                let wave_width: int = 560
                let wave_step: int = (/ waveform_size wave_width)
                
                unsafe {                 (SDL_SetRenderDrawColor renderer 0 255 200 220) }
                while (< i wave_width) {
                    let sample_idx: int = (* i wave_step)
                    let left: float = (nl_audio_viz_get_waveform_sample 0 sample_idx)
                    let right: float = (nl_audio_viz_get_waveform_sample 1 sample_idx)
                    let mixed: float = (* (+ left right) 0.5)
                    let y: int = (+ 232 (cast_int (* mixed 85.0)))
                    
                    unsafe {                     (SDL_RenderDrawPoint renderer (+ 20 i) y) }
                    unsafe {                     (SDL_RenderDrawPoint renderer (+ 20 i) (+ y 1)) }
                    set i (+ i 1)
                }
            } else {}
            
            # === 7. PLAYLIST CONTROL BUTTONS ===
            let playlist_btn_y: int = 330
            
            if (== (nl_ui_button renderer font "Browse..." 10 playlist_btn_y 85 22) 1) {
                set ui_mode MODE_BROWSER
                set browser_path (nl_prefs_get_home)
                set browser_scroll 0
                (println "[*] Switched to Browser mode")
                (print "    Path: ")
                (println browser_path)
            } else {}
            
            if (== (nl_ui_button renderer font "Clear" 100 playlist_btn_y 60 22) 1) {
                set playlist []
                set playlist_count 0
                set current_track_index 0
                if (!= playback_state STATE_STOPPED) {
                    unsafe {                     (Mix_HaltMusic) }
                    set playback_state STATE_STOPPED
                } else {}
                (println "Playlist cleared")
            } else {}
            
            if (== (nl_ui_button renderer font "Save" 165 playlist_btn_y 50 22) 1) {
                unsafe { (nl_prefs_save_playlist pref_path playlist playlist_count) }
                (println "âœ“ Saved")
            } else {}
            
            # === 8. PLAYLIST ===
            unsafe {             (nl_ui_label renderer small_font "Playlist:" 10 358 180 200 220 255) }
            
            if (== playlist_count 0) {
                unsafe {                 (nl_ui_label renderer tiny_font "No tracks - click Browse to add music" 20 380 150 150 150 255) }
            } else {
                let clicked: int = (nl_ui_scrollable_list renderer tiny_font playlist
                                                           playlist_count
                                                           10 375 580 245 0 current_track_index)
                if (!= clicked -1) {
                    set current_track_index clicked
                    set playback_time 0
                    set playback_start_ticks (SDL_GetTicks)
                    
                    # Auto-play with error handling
                    let track_path: string = (at playlist clicked)
                    let load_result: int = (try_load_and_play_music track_path)
                    if (== load_result 1) {
                        # Successfully loaded and playing
                        set playback_state STATE_PLAYING
                        set playback_start_ticks (SDL_GetTicks)
                    } else {
                        # Failed to load - show error message
                        (println "[*] Error: Cannot play selected track")
                        (println "[*] The file may be corrupt or unsupported format")
                        
                        # Keep player in stopped state
                        set playback_state STATE_STOPPED
                    }
                } else {}
            }
            
            # === 9. STATUS BAR ===
            unsafe {             (nl_ui_panel renderer 0 625 600 25 5 8 12 255) }
            
            # Playback status
            let mut status_text: string = ""
            if (== playback_state STATE_PLAYING) { set status_text "> Playing" } else {}
            if (== playback_state STATE_PAUSED) { set status_text "|| Paused" } else {}
            if (== playback_state STATE_STOPPED) { set status_text "[] Stopped" } else {}
            unsafe {             (nl_ui_label renderer tiny_font status_text 10 630 150 200 255 255) }
            
            # Shuffle/Repeat status
            let mut mode_status: string = ""
            if (== shuffle_mode 1) {
                set mode_status "Shuffle"
            } else {}
            if (== repeat_mode REPEAT_ALL) {
                if (== shuffle_mode 1) {
                    set mode_status "Shuffle, Repeat All"
                } else {
                    set mode_status "Repeat All"
                }
            } else {}
            if (== repeat_mode REPEAT_ONE) {
                set mode_status "Repeat One"
            } else {}
            
            if (!= mode_status "") {
                unsafe {                 (nl_ui_label renderer tiny_font mode_status 250 630 120 180 220 255) }
            } else {}
            
            # Version info
            unsafe {             (nl_ui_label renderer tiny_font "NanoAmp v2.0" 510 630 100 140 160 255) }
        }
        
        # Draw on-screen help
        unsafe {         (nl_draw_text_blended renderer font "Space: Play/Pause | N: Next | P: Prev | ESC: Quit" 10 10 255 255 255 255) }
        
        # Present frame
        unsafe {         (SDL_RenderPresent renderer) }
        unsafe {         (SDL_Delay 16) }
        
        set frame (+ frame 1)
    }
    
    # === CLEANUP ===
    (println "")
    (println "Saving playlist...")
    let save_result: int = (nl_prefs_save_playlist pref_path playlist playlist_count)
    if (== save_result 1) {
        (println "âœ“ Playlist saved")
    } else {}
    
    (println "Cleaning up...")
    unsafe {     (Mix_HaltMusic) }
    unsafe {     (nl_audio_viz_shutdown) }
    unsafe {     (TTF_CloseFont font) }
    unsafe {     (TTF_CloseFont title_font) }
    unsafe {     (TTF_CloseFont small_font) }
    unsafe {     (TTF_CloseFont tiny_font) }
    unsafe {     (SDL_DestroyRenderer renderer) }
    unsafe {     (SDL_DestroyWindow window) }
    unsafe {     (TTF_Quit) }
    unsafe {     (Mix_CloseAudio) }
    unsafe {     (Mix_Quit) }
    unsafe {     (SDL_Quit) }
    
    (println "âœ“ Done")
    (println "")
    return 0
}

shadow main { assert true }
