# SDL_image Test - Load and display PNG icons
# This example demonstrates loading PNG icons using SDL_image

import "modules/sdl/sdl.nano"
import "modules/sdl_helpers/sdl_helpers.nano"
import "modules/sdl_image/sdl_image.nano"

fn main() -> int {
    # Initialize SDL
    unsafe { (SDL_Init 32) }
    
    # Initialize SDL_image with PNG support
    let img_flags: int = (IMG_Init IMG_INIT_PNG)
    if (== img_flags 0) {
        (println "Failed to initialize SDL_image!")
        let error: string = (IMG_GetError)
        (println (+ "Error: " error))
        return 1
    } else {}
    
    (println "SDL_image initialized successfully")
    
    # Create window and renderer
    let window: SDL_Window = (SDL_CreateWindow "SDL_image Test - Icon Display"
                                                100 100 640 480 4)
    let renderer: SDL_Renderer = (SDL_CreateRenderer window -1 2)
    
    if (== renderer 0) {
        (println "Failed to create renderer")
        return 1
    } else {}
    
    # Load icon textures
    (println "Loading icons...")
    let icon1: int = (nl_img_load_png_texture renderer "examples/icons/sdl_asteroids.png")
    let icon2: int = (nl_img_load_png_texture renderer "examples/icons/sdl_checkers.png")
    let icon3: int = (nl_img_load_png_texture renderer "examples/icons/sdl_pong.png")
    let icon4: int = (nl_img_load_png_texture renderer "examples/icons/sdl_fire.png")
    
    if (== icon1 0) {
        (println "Failed to load sdl_asteroids.png - make sure icons are generated!")
        (println "Hint: Run the icon extraction script first")
        return 1
    } else {
        (println "✓ Icons loaded successfully")
    }
    
    # Main loop
    (println "")
    (println "Displaying icons in window...")
    (println "Click the window close button to exit")
    (println "")
    
    let mut running: bool = true
    while running {
        # Check for quit event
        let quit: int = (nl_sdl_poll_event_quit)
        if (== quit 1) {
            set running false
        } else {}
        
        # Clear screen to dark blue
        unsafe { (SDL_SetRenderDrawColor renderer 20 30 50 255) }
        unsafe { (SDL_RenderClear renderer) }
        
        # Render icons in a 2x2 grid
        # Top left
        unsafe { (nl_img_render_texture renderer icon1 50 50 100 100) }
        # Top right
        unsafe { (nl_img_render_texture renderer icon2 200 50 100 100) }
        # Bottom left
        unsafe { (nl_img_render_texture renderer icon3 50 200 100 100) }
        # Bottom right
        unsafe { (nl_img_render_texture renderer icon4 200 200 100 100) }
        
        # Present
        unsafe { (SDL_RenderPresent renderer) }
        unsafe { (SDL_Delay 16) }
    }
    
    # Cleanup
    (println "Cleaning up...")
    unsafe { (nl_img_destroy_texture icon1) }
    unsafe { (nl_img_destroy_texture icon2) }
    unsafe { (nl_img_destroy_texture icon3) }
    unsafe { (nl_img_destroy_texture icon4) }
    
    unsafe { (SDL_DestroyRenderer renderer) }
    unsafe { (SDL_DestroyWindow window) }
    unsafe { (IMG_Quit) }
    unsafe { (SDL_Quit) }
    
    (println "✓ SDL_image test completed successfully")
    return 0
}

shadow main {
    # Cannot test with shadow as it requires SDL context
    assert (== 1 1)
}

