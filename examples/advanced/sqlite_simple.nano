# Simple SQLite Database Example  
# Demonstrates SECURE database operations with SQLite3
#
# Concept: Safe database CRUD with prepared statements
# Topics: SQL, database security, parameter binding
# Difficulty: Intermediate
#
# Description:
# Shows secure database operations using prepared statements
# to prevent SQL injection attacks. Demonstrates proper use
# of nl_sqlite3_prepare with result iteration.
#
# Key Features Demonstrated:
# - Prepared statements (nl_sqlite3_prepare) for queries
# - Result iteration with nl_sqlite3_step
# - Column access (nl_sqlite3_column_*)
# - Proper resource cleanup (nl_sqlite3_finalize)
#
# SECURITY NOTE:
# This example is SAFE because it uses:
# âœ… Hardcoded SQL strings (no user input concatenation)
# âœ… Prepared statements for queries
#
# For dynamic queries with user input, ALWAYS use parameter binding:
# âœ… SAFE:   let stmt = (nl_sqlite3_prepare db "SELECT * FROM users WHERE id = ?")
#            (nl_sqlite3_bind_int stmt 1 user_id)
#
# âŒ UNSAFE: Concatenating user input into SQL string
#            This would allow SQL injection attacks!

module "modules/sqlite/sqlite.nano"

fn main() -> int {
    (println "")
    (println "ğŸ“‡ SQLite Database Example")
    (println "==========================")
    (println "")
    
    # Open database
    let db_path: string = "test.db"
    let mut db: int = 0
    unsafe {
        set db (nl_sqlite3_open db_path)
    }
    
    if (== db 0) {
        (println "âŒ Failed to open database")
        return 1
    } else {
        (print "âœ“ Database opened: ")
        (println db_path)
    }
    
    # Create table
    (println "")
    (println "Creating table...")
    let create_sql: string = "CREATE TABLE IF NOT EXISTS contacts (id INTEGER PRIMARY KEY, name TEXT, email TEXT)"
    let mut create_result: int = 0
    unsafe {
        set create_result (nl_sqlite3_exec db create_sql)
    }
    
    if (== create_result 0) {
        (println "âœ“ Table created")
    } else {
        (print "âŒ Create failed: ")
        let mut create_error: string = ""
        unsafe {
            set create_error (nl_sqlite3_errmsg db)
        }
        (println create_error)
    }
    
    # Insert data
    (println "")
    (println "Inserting contacts...")
    let insert1: string = "INSERT INTO contacts (name, email) VALUES ('Alice', 'alice@example.com')"
    unsafe {
        (nl_sqlite3_exec db insert1)
    }
    (println "âœ“ Inserted Alice")
    
    let insert2: string = "INSERT INTO contacts (name, email) VALUES ('Bob', 'bob@example.com')"
    unsafe {
        (nl_sqlite3_exec db insert2)
    }
    (println "âœ“ Inserted Bob")
    
    # Query data
    (println "")
    (println "Querying all contacts...")
    (println "")
    
    let select_sql: string = "SELECT id, name, email FROM contacts"
    let mut stmt: int = 0
    unsafe {
        set stmt (nl_sqlite3_prepare db select_sql)
    }
    
    if (== stmt 0) {
        (println "âŒ Failed to prepare query")
    } else {
        let mut running: bool = true
        let mut count: int = 0
        
        while running {
            let mut result: int = 0
            unsafe {
                set result (nl_sqlite3_step stmt)
            }
            
            if (== result 100) {  # SQLITE_ROW
                set count (+ count 1)
                
                let mut id: int = 0
                let mut name: string = ""
                let mut email: string = ""
                unsafe {
                    set id (nl_sqlite3_column_int stmt 0)
                    set name (nl_sqlite3_column_text stmt 1)
                    set email (nl_sqlite3_column_text stmt 2)
                }
                
                (print "ID: ")
                (print id)
                (print " | Name: ")
                (print name)
                (print " | Email: ")
                (println email)
            } else {
                set running false
            }
        }
        
        unsafe {
            (nl_sqlite3_finalize stmt)
        }
        
        (println "")
        (print "Total: ")
        (print count)
        (println " contacts")
    }
    
    # Close database
    unsafe {
        (nl_sqlite3_close db)
    }
    
    (println "")
    (println "âœ… Database operations completed!")
    (println "")
    (print "View with: sqlite3 ")
    (println db_path)
    (println "")
    
    return 0
}

shadow main {
    # Uses extern functions
    assert true
}
