# Nanolang Project Rules - Keep It Green! ðŸŸ¢

## Core Principle: Always Green

This project maintains 100% passing tests. **Any commit that breaks tests is unacceptable.**

## Self-Hosted Parser Requirements

The self-hosted parser (`src_nano/parser_mvp.nano`) must:

1. âœ… **Compile successfully** with zero errors
2. âœ… **Pass all shadow tests** (internal validation)
3. âœ… **Parse itself** (self-hosting validation)
4. âœ… **Support all features** it uses in its own code

### When Adding Language Features

If you add a new language feature to nanolang:

1. **Stage 0 (C Compiler):**  
   - Add feature to `src/parser.c` first
   - Ensure C compiler handles it (100% support required)

2. **Stage 2 (Self-Hosted Parser):**  
   - Add corresponding AST struct in `parser_mvp.nano`
   - Add `parser_store_*` function
   - **Integrate into parsing logic** (critical!)
   - Add token helpers if needed

3. **Testing:**  
   - Run `./bin/nanoc src_nano/parser_mvp.nano` - must pass âœ…
   - Run `./tests/run_all_tests.sh` - must pass âœ…
   - Run `make examples` - must build âœ…

4. **Documentation:**  
   - Update feature lists in markdown docs
   - Update completion percentages

### Self-Hosting Check

Before committing parser changes:

```bash
# Must succeed with zero errors
./bin/nanoc src_nano/parser_mvp.nano

# Must show PASSED
./tests/run_all_tests.sh | grep "All runnable tests passed"
```

## Test Requirements

### All Code Changes Must:

- âœ… Pass compilation (zero errors)
- âœ… Pass all existing tests
- âœ… Not break self-hosting
- âœ… Include tests for new features
- âœ… Update documentation

### Running Tests

```bash
# Quick check
./bin/nanoc src_nano/parser_mvp.nano

# Full test suite
./tests/run_all_tests.sh

# Examples
make examples
```

### Test Coverage Standards

- **Unit tests:** Must pass 100%
- **Integration tests:** Must pass 100%
- **Shadow tests:** Must pass 100%
- **Self-hosting:** Must validate 100%

## Code Quality Standards

### Parser Changes

1. **Never break existing functionality**
2. **Always add shadow tests for new functions**
3. **Keep architecture consistent**
4. **Document complex logic**

### Commit Requirements

Before committing:
- [ ] Code compiles
- [ ] Tests pass
- [ ] Self-hosting works
- [ ] Documentation updated

### CI/CD Philosophy

This project follows **"Always Green"** methodology:
- Main branch: Always passing tests
- Feature branches: Must pass before merge
- No exceptions for "will fix later"

## Architecture Principles

### Parser Architecture

The self-hosted parser has:
- **31 node types** (complete)
- **29 AST structs** (complete)
- **67 Parser fields** (complete)
- **22+ parsing functions** (production-ready)

### Adding New Node Types

1. Add to `ParseNodeType` enum
2. Create AST struct definition
3. Add list field to Parser struct
4. Add count field to Parser struct
5. Initialize in `parser_init_ast_lists`
6. Initialize in `parser_new`
7. Create `parser_store_*` function (copy pattern from existing)
8. Add parsing logic to appropriate `parse_*` function
9. **Test immediately**

### Code Patterns

Follow existing patterns:
- Use functional style (return new Parser)
- No mutations except with `mut` keyword
- Consistent error handling
- Shadow tests for validation

## Documentation Standards

### Required Documentation

When making changes:
- Update `REMAINING_WORK.md` if applicable
- Update completion percentages
- Document new features in markdown
- Update `IMPLEMENTATION_GUIDE.md` if adding complex features

### Code Comments

- Document WHY, not WHAT
- Complex algorithms need explanation
- Edge cases should be noted
- TODOs must have tracking

## Git Workflow

### Branch Names
- `feat/*` - New features
- `fix/*` - Bug fixes
- `docs/*` - Documentation only
- `test/*` - Test additions

### Commit Messages

Format:
```
type: Brief description

Detailed explanation if needed

- Changes made
- Tests: status
- Self-hosting: status
```

Types: `feat`, `fix`, `docs`, `test`, `refactor`, `perf`

### Pre-Commit Checklist

```bash
# 1. Compile check
./bin/nanoc src_nano/parser_mvp.nano || exit 1

# 2. Test check  
./tests/run_all_tests.sh || exit 1

# 3. Self-hosting check
./bin/nanoc src_nano/lexer_complete.nano || exit 1
```

## Performance Standards

### Parser Performance

- Must compile itself in < 10 seconds
- No memory leaks
- Reasonable file size (< 5000 lines preferred)
- Clean compilation (no warnings)

## Error Handling

### Parser Errors

- Use `parser_with_error` for syntax errors
- Include line/column information
- Provide clear error messages
- Never silently fail

## Future-Proofing

### When at 100% Completion

Once parser reaches 100% feature coverage:

1. **Lock Feature Parity:**  
   Any C parser feature MUST have self-hosted equivalent

2. **Test Coverage:**  
   New features MUST include tests

3. **Documentation:**  
   Feature docs MUST be complete before merge

4. **Green Status:**  
   NO commits that break tests, ever

## Emergency Procedures

### If Tests Break

1. **DO NOT** commit broken code
2. **DO NOT** merge to main
3. Fix immediately or revert
4. Investigate root cause
5. Add tests to prevent recurrence

### If Self-Hosting Breaks

**CRITICAL:** This is a blocker. Must fix before any other work.

1. Identify which feature broke it
2. Check if parser uses that feature
3. Fix or revert immediately
4. Add test to catch this pattern

## Success Metrics

### Green Status Indicators

- âœ… All tests passing
- âœ… Self-hosting works
- âœ… Zero compilation errors
- âœ… Zero warnings
- âœ… Examples build
- âœ… Documentation current

### Quality Metrics

- Test pass rate: 100%
- Coverage: >95%
- Self-hosting: Validated
- Performance: < 10s compile time

## Temporary AI Planning Files

**NEVER commit temporary AI planning/status files to the repository.**

### What Are Temporary Files?

Any `.md` file in the top-level directory that was created during AI-assisted development sessions:
- `*_STATUS.md`, `*_SUMMARY.md`, `*_GUIDE.md`
- `IMPLEMENTATION_*.md`, `REMAINING_*.md`, `WORK_*.md`
- `VICTORY_*.md`, `FINAL_*.md`, `FEATURES_*.md`
- Any planning, tracking, or status documentation

### Rules for Temporary Files

1. **Do NOT commit** these files to the repository
2. **If committed by mistake**, remove immediately:
   ```bash
   git rm TEMPORARY_FILE.md
   git commit -m "chore: Remove temporary AI planning file"
   ```

3. **Extract user-facing content** before deletion:
   - Installation/setup changes â†’ `README.md`
   - User documentation â†’ `docs/` directory
   - API documentation â†’ appropriate `docs/*.md`
   - Discard internal planning/status content

### What Belongs Where

| Content Type | Destination |
|-------------|-------------|
| Installation instructions | `README.md` |
| User guides | `docs/` |
| API documentation | `docs/` |
| Architecture docs | `docs/architecture/` |
| Contributing guidelines | `CONTRIBUTING.md` |
| AI planning/status | **DELETE - do not commit** |

### Pre-Commit Check

Before committing, verify no temporary files are staged:
```bash
# Check for suspicious top-level .md files
ls *.md | grep -v -E "^(README|CONTRIBUTING|CONTRIBUTORS|LICENSE)\.md$"

# If any appear, either:
# 1. Extract useful content to proper location
# 2. Add to .gitignore
# 3. Delete the file
```

### Allowed Top-Level Markdown Files

Only these `.md` files should exist at the project root:
- `README.md` - Project overview and setup
- `CONTRIBUTING.md` - Contribution guidelines
- `CONTRIBUTORS.md` - List of contributors
- `LICENSE.md` (or `LICENSE`) - License information

Everything else belongs in `docs/` or should not be committed.

## Remember

**"Always Green" means ALWAYS GREEN.**

No exceptions. No "temporary breaks". No "will fix tomorrow".

If it breaks tests, it doesn't get committed.  
If it breaks self-hosting, it's a critical bug.  
If examples fail, it's blocking.
If it's a temporary planning file, it doesn't get committed.

Keep nanolang green! ðŸŸ¢
