# Test module introspection - exported functions and structs tracking
# Tests the ___module_function_count_<NAME> and ___module_struct_count_<NAME> functions

module test_math

pub struct Point {
    x: int,
    y: int
}

pub struct Vector {
    dx: float,
    dy: float
}

# Private struct - should NOT be in exported list
struct Internal {
    data: int
}

pub fn add(a: int, b: int) -> int {
    return (+ a b)
}

shadow add {
    assert (== (add 2 3) 5)
}

pub fn multiply(a: int, b: int) -> int {
    return (* a b)
}

shadow multiply {
    assert (== (multiply 3 4) 12)
}

# Private function - should NOT be in exported list
fn helper(x: int) -> int {
    return (* x 2)
}

shadow helper {
    assert (== (helper 5) 10)
}

pub fn distance_squared(p1: Point, p2: Point) -> int {
    let dx: int = (- p2.x p1.x)
    let dy: int = (- p2.y p1.y)
    return (+ (* dx dx) (* dy dy))
}

shadow distance_squared {
    let p1: Point = Point { x: 0, y: 0 }
    let p2: Point = Point { x: 3, y: 4 }
    assert (== (distance_squared p1 p2) 25)
}

# Introspection functions (generated by transpiler)
extern fn ___module_function_count_test_math() -> int
extern fn ___module_struct_count_test_math() -> int
extern fn ___module_is_unsafe_test_math() -> bool
extern fn ___module_has_ffi_test_math() -> bool

fn main() -> int {
    (println "=== Module Introspection Test ===")
    
    # Test module safety flags
    let is_unsafe: bool = (___module_is_unsafe_test_math)
    let has_ffi: bool = (___module_has_ffi_test_math)
    
    (print "Module is unsafe: ")
    (println (cond (is_unsafe "true") (else "false")))
    
    (print "Module has FFI: ")
    (println (cond (has_ffi "true") (else "false")))
    
    # Test exported functions count
    let func_count: int = (___module_function_count_test_math)
    
    (print "Exported functions count: ")
    (println (int_to_string func_count))
    
    (println "Expected: 3 functions (add, multiply, distance_squared)")
    if (!= func_count 3) {
        (println "ERROR: Function count mismatch!")
        return 1
    }
    
    # Test exported structs count
    let struct_count: int = (___module_struct_count_test_math)
    
    (print "Exported structs count: ")
    (println (int_to_string struct_count))
    
    (println "Expected: 2 structs (Point, Vector)")
    if (!= struct_count 2) {
        (println "ERROR: Struct count mismatch!")
        return 1
    }
    
    (println "âœ“ All module introspection tests passed!")
    
    return 0
}

shadow main {
    assert (== (main) 0)
}
