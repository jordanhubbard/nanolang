/* End-to-End Driver Integration Test
 * Tests the full compilation pipeline through the self-hosted driver
 */

/* This test validates that all compiler phases work together correctly */

fn test_simple_program() -> int {
    /* Simple program that should compile and run successfully */
    return 42
}

shadow test_simple_program {
    assert (== (test_simple_program) 42)
}

fn test_with_variables() -> int {
    let x: int = 10
    let y: int = 20
    return (+ x y)
}

shadow test_with_variables {
    assert (== (test_with_variables) 30)
}

fn test_with_conditionals() -> int {
    let x: int = 5
    if (> x 0) {
        return 1
    } else {
        return 0
    }
}

shadow test_with_conditionals {
    assert (== (test_with_conditionals) 1)
}

fn test_with_loops() -> int {
    let mut sum: int = 0
    let mut i: int = 0
    while (< i 5) {
        set sum (+ sum i)
        set i (+ i 1)
    }
    return sum
}

shadow test_with_loops {
    assert (== (test_with_loops) 10)
}

fn factorial(n: int) -> int {
    if (<= n 1) {
        return 1
    }
    return (* n (factorial (- n 1)))
}

shadow factorial {
    assert (== (factorial 0) 1)
    assert (== (factorial 1) 1)
    assert (== (factorial 5) 120)
}

struct Point {
    x: int,
    y: int
}

fn test_with_structs() -> int {
    let p: Point = Point { x: 10, y: 20 }
    return (+ p.x p.y)
}

shadow test_with_structs {
    assert (== (test_with_structs) 30)
}

union Result {
    Ok { value: int },
    Err { code: int }
}

fn test_with_unions() -> int {
    let r: Result = Result.Ok { value: 42 }
    match r {
        Ok(v) => {
            return v.value
        }
        Err(e) => {
            return (- 0 1)
        }
    }
}

shadow test_with_unions {
    assert (== (test_with_unions) 42)
}

fn test_with_arrays() -> int {
    let arr: array<int> = [1, 2, 3, 4, 5]
    let mut sum: int = 0
    let mut i: int = 0
    while (< i 5) {
        set sum (+ sum (at arr i))
        set i (+ i 1)
    }
    return sum
}

shadow test_with_arrays {
    assert (== (test_with_arrays) 15)
}

fn test_first_class_functions() -> int {
    let f: fn(int) -> int = double
    return (f 21)
}

fn double(x: int) -> int {
    return (* x 2)
}

shadow double {
    assert (== (double 5) 10)
}

shadow test_first_class_functions {
    assert (== (test_first_class_functions) 42)
}

/* Test that the driver handles all major language features:
 * ✓ Functions
 * ✓ Variables (let, mut, set)
 * ✓ Control flow (if, while)
 * ✓ Recursion
 * ✓ Structs
 * ✓ Unions with match
 * ✓ Arrays
 * ✓ First-class functions
 */

fn main() -> int {
    assert (== (test_simple_program) 42)
    assert (== (test_with_variables) 30)
    assert (== (test_with_conditionals) 1)
    assert (== (test_with_loops) 10)
    assert (== (factorial 5) 120)
    assert (== (test_with_structs) 30)
    assert (== (test_with_unions) 42)
    assert (== (test_with_arrays) 15)
    assert (== (test_first_class_functions) 42)
    return 0
}

