/* =============================================================================
 * nanolang Lexer (Self-Hosted)
 * =============================================================================
 * This is the lexer implementation written in nanolang itself.
 * It tokenizes nanolang source code into a stream of tokens.
 */

/* Token types as an enum */
enum TokenType {
    TOKEN_EOF = 0,
    TOKEN_NUMBER = 1,
    TOKEN_FLOAT = 2,
    TOKEN_STRING = 3,
    TOKEN_IDENTIFIER = 4,
    TOKEN_TRUE = 5,
    TOKEN_FALSE = 6,
    
    /* Delimiters */
    TOKEN_LPAREN = 7,
    TOKEN_RPAREN = 8,
    TOKEN_LBRACE = 9,
    TOKEN_RBRACE = 10,
    TOKEN_LBRACKET = 11,
    TOKEN_RBRACKET = 12,
    TOKEN_COMMA = 13,
    TOKEN_COLON = 14,
    TOKEN_ARROW = 15,
    TOKEN_ASSIGN = 16,
    TOKEN_DOT = 17,
    
    /* Keywords */
    TOKEN_EXTERN = 18,
    TOKEN_FN = 19,
    TOKEN_LET = 20,
    TOKEN_MUT = 21,
    TOKEN_SET = 22,
    TOKEN_IF = 23,
    TOKEN_ELSE = 24,
    TOKEN_WHILE = 25,
    TOKEN_FOR = 26,
    TOKEN_IN = 27,
    TOKEN_RETURN = 28,
    TOKEN_ASSERT = 29,
    TOKEN_SHADOW = 30,
    TOKEN_PRINT = 31,
    TOKEN_ARRAY = 32,
    TOKEN_STRUCT = 33,
    TOKEN_ENUM = 34,
    TOKEN_UNION = 35,
    TOKEN_MATCH = 36,
    
    /* Type keywords */
    TOKEN_TYPE_INT = 37,
    TOKEN_TYPE_FLOAT = 38,
    TOKEN_TYPE_BOOL = 39,
    TOKEN_TYPE_STRING = 40,
    TOKEN_TYPE_VOID = 41,
    
    /* Operators */
    TOKEN_PLUS = 42,
    TOKEN_MINUS = 43,
    TOKEN_STAR = 44,
    TOKEN_SLASH = 45,
    TOKEN_PERCENT = 46,
    TOKEN_EQ = 47,
    TOKEN_NE = 48,
    TOKEN_LT = 49,
    TOKEN_LE = 50,
    TOKEN_GT = 51,
    TOKEN_GE = 52,
    TOKEN_AND = 53,
    TOKEN_OR = 54,
    TOKEN_NOT = 55,
    TOKEN_RANGE = 56
}

/* Token structure */
struct Token {
    token_type: int,      /* TokenType enum value */
    value: string,        /* Token value (for identifiers, numbers, strings) */
    line: int,            /* Line number */
    column: int           /* Column number */
}

/* Character classification helpers */
fn is_whitespace(c: int) -> bool {
    return (or 
        (== c 32)   /* space */
        (or (== c 9)    /* tab */
        (or (== c 10)   /* newline */
        (== c 13))))    /* carriage return */
}

fn is_digit(c: int) -> bool {
    return (and (>= c 48) (<= c 57))  /* '0' to '9' */
}

fn is_alpha(c: int) -> bool {
    return (or
        (and (>= c 65) (<= c 90))   /* 'A' to 'Z' */
        (and (>= c 97) (<= c 122))) /* 'a' to 'z' */
}

fn is_identifier_start(c: int) -> bool {
    return (or (is_alpha c) (== c 95))  /* alphanumeric or '_' */
}

fn is_identifier_char(c: int) -> bool {
    return (or (is_alpha c) (or (is_digit c) (== c 95)))  /* alphanumeric or '_' */
}

/* String comparison */
fn str_equals(s1: string, s2: string) -> bool {
    let len1: int = (str_length s1)
    let len2: int = (str_length s2)
    
    if (!= len1 len2) {
        return false
    } else {}
    
    let mut i: int = 0
    while (< i len1) {
        if (!= (char_at s1 i) (char_at s2 i)) {
            return false
        } else {}
        set i (+ i 1)
    }
    
    return true
}

/* Extract substring */
fn substring(s: string, start: int, length: int) -> string {
    let mut result: string = ""
    let mut i: int = 0
    while (< i length) {
        let c: int = (char_at s (+ start i))
        set result (str_concat result (string_from_char c))
        set i (+ i 1)
    }
    return result
}

/* Keyword classification */
fn keyword_or_identifier(word: string) -> int {
    /* Keywords */
    if (str_equals word "extern") { return TokenType.EXTERN } else {}
    if (str_equals word "fn") { return TokenType.FN } else {}
    if (str_equals word "let") { return TokenType.LET } else {}
    if (str_equals word "mut") { return TokenType.MUT } else {}
    if (str_equals word "set") { return TokenType.SET } else {}
    if (str_equals word "if") { return TokenType.IF } else {}
    if (str_equals word "else") { return TokenType.ELSE } else {}
    if (str_equals word "while") { return TokenType.WHILE } else {}
    if (str_equals word "for") { return TokenType.FOR } else {}
    if (str_equals word "in") { return TokenType.IN } else {}
    if (str_equals word "return") { return TokenType.RETURN } else {}
    if (str_equals word "assert") { return TokenType.ASSERT } else {}
    if (str_equals word "shadow") { return TokenType.SHADOW } else {}
    if (str_equals word "print") { return TokenType.PRINT } else {}
    if (str_equals word "array") { return TokenType.ARRAY } else {}
    if (str_equals word "struct") { return TokenType.STRUCT } else {}
    if (str_equals word "enum") { return TokenType.ENUM } else {}
    if (str_equals word "union") { return TokenType.UNION } else {}
    if (str_equals word "match") { return TokenType.MATCH } else {}
    
    /* Boolean literals */
    if (str_equals word "true") { return TokenType.TRUE } else {}
    if (str_equals word "false") { return TokenType.FALSE } else {}
    
    /* Types */
    if (str_equals word "int") { return TokenType.TYPE_INT } else {}
    if (str_equals word "float") { return TokenType.TYPE_FLOAT } else {}
    if (str_equals word "bool") { return TokenType.TYPE_BOOL } else {}
    if (str_equals word "string") { return TokenType.TYPE_STRING } else {}
    if (str_equals word "void") { return TokenType.TYPE_VOID } else {}
    
    /* Operators */
    if (str_equals word "and") { return TokenType.AND } else {}
    if (str_equals word "or") { return TokenType.OR } else {}
    if (str_equals word "not") { return TokenType.NOT } else {}
    if (str_equals word "range") { return TokenType.RANGE } else {}
    
    return TokenType.IDENTIFIER
}

/* Create a token */
fn create_token(token_type: int, value: string, line: int, column: int) -> Token {
    return Token {
        token_type: token_type,
        value: value,
        line: line,
        column: column
    }
}

/* Main tokenization function */
fn tokenize(source: string) -> array<Token> {
    let source_len: int = (str_length source)
    let mut tokens: array<Token> = []
    let mut i: int = 0
    let mut line: int = 1
    let mut column: int = 1
    let mut line_start: int = 0
    
    while (< i source_len) {
        let c: int = (char_at source i)
        
        /* Skip whitespace */
        if (is_whitespace c) {
            if (== c 10) {  /* newline */
                set line (+ line 1)
                set line_start (+ i 1)
                set column 1
            } else {}
            set i (+ i 1)
        } else {
            /* Skip line comments (# to end of line) */
            if (== c 35) {  /* '#' */
                while (and (< i source_len) (!= (char_at source i) 10)) {
                    set i (+ i 1)
                }
            } else {
                /* Skip C-style comments (slash-star ... star-slash) */
                if (and (== c 47) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 42))) {  /* '/' and '*' */
                    set i (+ i 2)
                    while (< i source_len) {
                        if (and (== (char_at source i) 42) 
                               (and (< (+ i 1) source_len) 
                                    (== (char_at source (+ i 1)) 47))) {  /* '*' and '/' */
                            set i (+ i 2)
                            break
                        } else {}
                        if (== (char_at source i) 10) {  /* newline */
                            set line (+ line 1)
                            set line_start (+ i 1)
                        } else {}
                        set i (+ i 1)
                    }
                } else {
                    /* Update column for this token */
                    set column (+ (- i line_start) 1)
                    
                    /* String literals */
                    if (== c 34) {  /* '"' */
                        set i (+ i 1)
                        let start: int = i
                        while (and (< i source_len) (!= (char_at source i) 34)) {
                            if (and (== (char_at source i) 92)  /* '\\' */
                                   (< (+ i 1) source_len)) {
                                set i (+ i 2)
                            } else {
                                set i (+ i 1)
                            }
                        }
                        
                        let str_value: string = (substring source start (- i start))
                        let token: Token = (create_token TokenType.STRING str_value line column)
                        set tokens (array_push tokens token)
                        
                        if (< i source_len) {
                            set i (+ i 1)  /* Skip closing quote */
                        } else {}
                    } else {
                        /* Numbers (integers and floats) */
                        if (or (is_digit c) 
                              (and (== c 45) 
                                   (and (< (+ i 1) source_len) 
                                        (is_digit (char_at source (+ i 1)))))) {  /* '-' followed by digit */
                            let start: int = i
                            if (== c 45) { set i (+ i 1) } else {}  /* Skip minus */
                            
                            while (and (< i source_len) (is_digit (char_at source i))) {
                                set i (+ i 1)
                            }
                            
                            /* Check for float */
                            if (and (< i source_len) 
                                   (and (== (char_at source i) 46)  /* '.' */
                                        (and (< (+ i 1) source_len) 
                                             (is_digit (char_at source (+ i 1)))))) {
                                set i (+ i 1)
                                while (and (< i source_len) (is_digit (char_at source i))) {
                                    set i (+ i 1)
                                }
                                let num_str: string = (substring source start (- i start))
                                let token: Token = (create_token TokenType.FLOAT num_str line column)
                                set tokens (array_push tokens token)
                            } else {
                                let num_str: string = (substring source start (- i start))
                                let token: Token = (create_token TokenType.NUMBER num_str line column)
                                set tokens (array_push tokens token)
                            }
                        } else {
                            /* Identifiers and keywords */
                            if (is_identifier_start c) {
                                let start: int = i
                                while (and (< i source_len) (is_identifier_char (char_at source i))) {
                                    set i (+ i 1)
                                }
                                let id_str: string = (substring source start (- i start))
                                let token_type: int = (keyword_or_identifier id_str)
                                let token: Token = (create_token token_type id_str line column)
                                set tokens (array_push tokens token)
                            } else {
                                /* Two-character operators */
                                if (and (== c 45) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 62))) {  /* '->' */
                                    let token: Token = (create_token TokenType.ARROW "" line column)
                                    set tokens (array_push tokens token)
                                    set i (+ i 2)
                                } else {
                                    if (and (== c 61) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 62))) {  /* '=>' */
                                        let token: Token = (create_token TokenType.ARROW "" line column)
                                        set tokens (array_push tokens token)
                                        set i (+ i 2)
                                    } else {
                                        if (and (== c 61) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 61))) {  /* '==' */
                                            let token: Token = (create_token TokenType.EQ "" line column)
                                            set tokens (array_push tokens token)
                                            set i (+ i 2)
                                        } else {
                                            if (and (== c 33) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 61))) {  /* '!=' */
                                                let token: Token = (create_token TokenType.NE "" line column)
                                                set tokens (array_push tokens token)
                                                set i (+ i 2)
                                            } else {
                                                if (and (== c 60) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 61))) {  /* '<=' */
                                                    let token: Token = (create_token TokenType.LE "" line column)
                                                    set tokens (array_push tokens token)
                                                    set i (+ i 2)
                                                } else {
                                                    if (and (== c 62) (and (< (+ i 1) source_len) (== (char_at source (+ i 1)) 61))) {  /* '>=' */
                                                        let token: Token = (create_token TokenType.GE "" line column)
                                                        set tokens (array_push tokens token)
                                                        set i (+ i 2)
                                                    } else {
                                                        /* Single '=' (must check it's not '==' or '=>') */
                                                        if (== c 61) {
                                                            let token: Token = (create_token TokenType.ASSIGN "" line column)
                                                            set tokens (array_push tokens token)
                                                            set i (+ i 1)
                                                        } else {
                                                            /* Single-character tokens */
                                                            if (== c 40) { /* '(' */
                                                                let token: Token = (create_token TokenType.LPAREN "" line column)
                                                                set tokens (array_push tokens token)
                                                                set i (+ i 1)
                                                            } else {
                                                                if (== c 41) { /* ')' */
                                                                    let token: Token = (create_token TokenType.RPAREN "" line column)
                                                                    set tokens (array_push tokens token)
                                                                    set i (+ i 1)
                                                                } else {
                                                                    if (== c 123) { /* '{' */
                                                                        let token: Token = (create_token TokenType.LBRACE "" line column)
                                                                        set tokens (array_push tokens token)
                                                                        set i (+ i 1)
                                                                    } else {
                                                                        if (== c 125) { /* '}' */
                                                                            let token: Token = (create_token TokenType.RBRACE "" line column)
                                                                            set tokens (array_push tokens token)
                                                                            set i (+ i 1)
                                                                        } else {
                                                                            if (== c 91) { /* '[' */
                                                                                let token: Token = (create_token TokenType.LBRACKET "" line column)
                                                                                set tokens (array_push tokens token)
                                                                                set i (+ i 1)
                                                                            } else {
                                                                                if (== c 93) { /* ']' */
                                                                                    let token: Token = (create_token TokenType.RBRACKET "" line column)
                                                                                    set tokens (array_push tokens token)
                                                                                    set i (+ i 1)
                                                                                } else {
                                                                                    if (== c 44) { /* ',' */
                                                                                        let token: Token = (create_token TokenType.COMMA "" line column)
                                                                                        set tokens (array_push tokens token)
                                                                                        set i (+ i 1)
                                                                                    } else {
                                                                                        if (== c 58) { /* ':' */
                                                                                            let token: Token = (create_token TokenType.COLON "" line column)
                                                                                            set tokens (array_push tokens token)
                                                                                            set i (+ i 1)
                                                                                        } else {
                                                                                            if (== c 46) { /* '.' */
                                                                                                let token: Token = (create_token TokenType.DOT "" line column)
                                                                                                set tokens (array_push tokens token)
                                                                                                set i (+ i 1)
                                                                                            } else {
                                                                                                if (== c 43) { /* '+' */
                                                                                                    let token: Token = (create_token TokenType.PLUS "" line column)
                                                                                                    set tokens (array_push tokens token)
                                                                                                    set i (+ i 1)
                                                                                                } else {
                                                                                                    if (== c 45) { /* '-' */
                                                                                                        let token: Token = (create_token TokenType.MINUS "" line column)
                                                                                                        set tokens (array_push tokens token)
                                                                                                        set i (+ i 1)
                                                                                                    } else {
                                                                                                        if (== c 42) { /* '*' */
                                                                                                            let token: Token = (create_token TokenType.STAR "" line column)
                                                                                                            set tokens (array_push tokens token)
                                                                                                            set i (+ i 1)
                                                                                                        } else {
                                                                                                            if (== c 47) { /* '/' */
                                                                                                                let token: Token = (create_token TokenType.SLASH "" line column)
                                                                                                                set tokens (array_push tokens token)
                                                                                                                set i (+ i 1)
                                                                                                            } else {
                                                                                                                if (== c 37) { /* '%' */
                                                                                                                    let token: Token = (create_token TokenType.PERCENT "" line column)
                                                                                                                    set tokens (array_push tokens token)
                                                                                                                    set i (+ i 1)
                                                                                                                } else {
                                                                                                                    if (== c 60) { /* '<' */
                                                                                                                        let token: Token = (create_token TokenType.LT "" line column)
                                                                                                                        set tokens (array_push tokens token)
                                                                                                                        set i (+ i 1)
                                                                                                                    } else {
                                                                                                                        if (== c 62) { /* '>' */
                                                                                                                            let token: Token = (create_token TokenType.GT "" line column)
                                                                                                                            set tokens (array_push tokens token)
                                                                                                                            set i (+ i 1)
                                                                                                                        } else {
                                                                                                                            /* Unknown character, skip it */
                                                                                                                            set i (+ i 1)
                                                                                                                        }
                                                                                                                    }
                                                                                                                }
                                                                                                            }
                                                                                                        }
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    /* Add EOF token */
    let eof_token: Token = (create_token TokenType.EOF "" line column)
    set tokens (array_push tokens eof_token)
    
    return tokens
}

/* Test helper: print token type name */
fn token_type_name(t: int) -> string {
    if (== t TokenType.EOF) { return "EOF" } else {}
    if (== t TokenType.NUMBER) { return "NUMBER" } else {}
    if (== t TokenType.FLOAT) { return "FLOAT" } else {}
    if (== t TokenType.STRING) { return "STRING" } else {}
    if (== t TokenType.IDENTIFIER) { return "IDENTIFIER" } else {}
    if (== t TokenType.TRUE) { return "TRUE" } else {}
    if (== t TokenType.FALSE) { return "FALSE" } else {}
    if (== t TokenType.LPAREN) { return "LPAREN" } else {}
    if (== t TokenType.RPAREN) { return "RPAREN" } else {}
    if (== t TokenType.LBRACE) { return "LBRACE" } else {}
    if (== t TokenType.RBRACE) { return "RBRACE" } else {}
    if (== t TokenType.LBRACKET) { return "LBRACKET" } else {}
    if (== t TokenType.RBRACKET) { return "RBRACKET" } else {}
    if (== t TokenType.FN) { return "FN" } else {}
    if (== t TokenType.LET) { return "LET" } else {}
    if (== t TokenType.RETURN) { return "RETURN" } else {}
    if (== t TokenType.PLUS) { return "PLUS" } else {}
    if (== t TokenType.MINUS) { return "MINUS" } else {}
    if (== t TokenType.STAR) { return "STAR" } else {}
    if (== t TokenType.EQ) { return "EQ" } else {}
    if (== t TokenType.ARROW) { return "ARROW" } else {}
    if (== t TokenType.COLON) { return "COLON" } else {}
    return "UNKNOWN"
}

/* Simple test function */
fn test_lexer() -> int {
    let source: string = "fn add(x: int, y: int) -> int { return (+ x y) }"
    let tokens: array<Token> = (tokenize source)
    let count: int = (array_length tokens)
    
    (println "Lexer test: tokenizing simple function")
    (print "Token count: ")
    (println count)
    
    /* Expected: fn, add, (, x, :, int, ..., ) */
    if (< count 10) {
        (println "ERROR: Too few tokens!")
        return 1
    } else {}
    
    return 0
}

fn main() -> int {
    return (test_lexer)
}

shadow test_lexer {
    assert (== (test_lexer) 0)
}

shadow main {
    assert (== (main) 0)
}
